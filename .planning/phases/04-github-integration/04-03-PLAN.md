---
phase: 04-github-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/lib/actions/github.ts
  - src/lib/github/queries.ts
  - src/app/backstage/dashboard/github/page.tsx
  - src/app/backstage/dashboard/github/repos-browser.tsx
  - src/components/admin/repo-card.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view paginated list of their GitHub repositories"
    - "Repository cards show name, description, stars, and primary language"
    - "Admin can search repositories by name"
    - "Admin can filter repositories by language"
    - "Loading states are visible during data fetch"
  artifacts:
    - path: "src/lib/github/queries.ts"
      provides: "GitHub API query functions"
      exports: ["fetchUserRepos", "searchUserRepos"]
    - path: "src/app/backstage/dashboard/github/repos-browser.tsx"
      provides: "Repository browser UI with search and filter"
      contains: "ReposBrowser"
    - path: "src/components/admin/repo-card.tsx"
      provides: "Individual repository card component"
      contains: "RepoCard"
  key_links:
    - from: "src/lib/actions/github.ts"
      to: "src/lib/github/queries.ts"
      via: "imports query functions"
      pattern: "import.*fetchUserRepos.*from"
    - from: "src/app/backstage/dashboard/github/repos-browser.tsx"
      to: "src/lib/actions/github.ts"
      via: "calls server action"
      pattern: "getRepositories"
---

<objective>
Create repository browser with paginated fetching, search, and filter capabilities.

Purpose: Allow admin to browse their GitHub repositories before selecting which to import as portfolio projects.
Output: Repository browser page with card grid, search by name, filter by language, pagination.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-github-integration/04-RESEARCH.md
@.planning/phases/04-github-integration/04-01-SUMMARY.md
@.planning/phases/04-github-integration/04-02-SUMMARY.md

# Existing files to reference
@src/lib/github/types.ts
@src/lib/github/client.ts
@src/lib/actions/github.ts
@src/app/backstage/dashboard/github/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub API query functions</name>
  <files>src/lib/github/queries.ts, src/lib/github/index.ts</files>
  <action>
1. Create `src/lib/github/queries.ts`:
   ```typescript
   // GitHub API query functions using Octokit
   // These are used by server actions for fetching repository data

   import type { Octokit } from 'octokit';
   import type { GitHubRepo, RepoListItem } from './types';
   import { toRepoListItem } from './types';

   export interface ReposResponse {
     repos: RepoListItem[];
     totalCount: number;
     hasMore: boolean;
   }

   /**
    * Fetch user repositories with pagination.
    * Returns simplified repo objects for UI display.
    */
   export async function fetchUserRepos(
     octokit: Octokit,
     options: {
       page?: number;
       perPage?: number;
       sort?: 'updated' | 'created' | 'pushed' | 'full_name';
     } = {}
   ): Promise<ReposResponse> {
     const { page = 1, perPage = 30, sort = 'updated' } = options;

     const response = await octokit.rest.repos.listForAuthenticatedUser({
       sort,
       direction: 'desc',
       per_page: perPage,
       page,
       visibility: 'all',
     });

     const repos = response.data.map((repo) =>
       toRepoListItem(repo as GitHubRepo)
     );

     return {
       repos,
       totalCount: repos.length, // Note: GitHub doesn't provide total count easily
       hasMore: response.data.length === perPage,
     };
   }

   /**
    * Search user repositories by name with optional language filter.
    * Fetches all repos and filters client-side (GitHub search API has limitations).
    */
   export async function searchUserRepos(
     octokit: Octokit,
     options: {
       query?: string;
       language?: string;
       page?: number;
       perPage?: number;
     } = {}
   ): Promise<ReposResponse> {
     const { query = '', language, page = 1, perPage = 30 } = options;

     // Fetch all repos (up to 100 per page for efficiency)
     // Note: For users with many repos, consider caching or pagination
     const response = await octokit.rest.repos.listForAuthenticatedUser({
       sort: 'updated',
       direction: 'desc',
       per_page: 100,
       visibility: 'all',
     });

     let allRepos = response.data.map((repo) =>
       toRepoListItem(repo as GitHubRepo)
     );

     // Filter by search query (case-insensitive name match)
     if (query) {
       const lowerQuery = query.toLowerCase();
       allRepos = allRepos.filter(
         (repo) =>
           repo.name.toLowerCase().includes(lowerQuery) ||
           repo.description?.toLowerCase().includes(lowerQuery)
       );
     }

     // Filter by language
     if (language) {
       allRepos = allRepos.filter(
         (repo) => repo.language?.toLowerCase() === language.toLowerCase()
       );
     }

     // Paginate filtered results
     const startIndex = (page - 1) * perPage;
     const paginatedRepos = allRepos.slice(startIndex, startIndex + perPage);

     return {
       repos: paginatedRepos,
       totalCount: allRepos.length,
       hasMore: startIndex + perPage < allRepos.length,
     };
   }

   /**
    * Get unique languages from user's repositories.
    * Useful for building the language filter dropdown.
    */
   export async function getRepoLanguages(octokit: Octokit): Promise<string[]> {
     const response = await octokit.rest.repos.listForAuthenticatedUser({
       per_page: 100,
       visibility: 'all',
     });

     const languages = new Set<string>();
     for (const repo of response.data) {
       if (repo.language) {
         languages.add(repo.language);
       }
     }

     return Array.from(languages).sort();
   }
   ```

2. Update `src/lib/github/index.ts` to export queries:
   ```typescript
   export { createGitHubClient } from './client';
   export { encryptToken, decryptToken } from './encryption';
   export * from './types';
   export * from './queries';
   ```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Exports are available from @/lib/github
  </verify>
  <done>fetchUserRepos, searchUserRepos, getRepoLanguages query functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Add repository server actions</name>
  <files>src/lib/actions/github.ts</files>
  <action>
1. Add to `src/lib/actions/github.ts`:
   ```typescript
   import { createGitHubClient, fetchUserRepos, searchUserRepos, getRepoLanguages, type RepoListItem, type ReposResponse } from "@/lib/github";

   /**
    * Get repositories from connected GitHub account.
    * Supports pagination, search, and language filtering.
    */
   export async function getRepositories(options: {
     page?: number;
     perPage?: number;
     query?: string;
     language?: string;
   } = {}): Promise<ActionResult<ReposResponse>> {
     const session = await auth();
     if (!session?.user) {
       return failure("Unauthorized");
     }

     const accessToken = await getGitHubAccessToken();
     if (!accessToken) {
       return failure("GitHub not connected");
     }

     try {
       const octokit = createGitHubClient(accessToken);

       // Use search if query or language filter provided
       if (options.query || options.language) {
         const result = await searchUserRepos(octokit, options);
         return success(result);
       }

       // Otherwise use simple pagination
       const result = await fetchUserRepos(octokit, options);
       return success(result);
     } catch (error) {
       console.error("Failed to fetch repositories:", error);
       return failure("Failed to fetch repositories from GitHub");
     }
   }

   /**
    * Get available languages for filter dropdown.
    */
   export async function getLanguages(): Promise<ActionResult<string[]>> {
     const session = await auth();
     if (!session?.user) {
       return failure("Unauthorized");
     }

     const accessToken = await getGitHubAccessToken();
     if (!accessToken) {
       return failure("GitHub not connected");
     }

     try {
       const octokit = createGitHubClient(accessToken);
       const languages = await getRepoLanguages(octokit);
       return success(languages);
     } catch (error) {
       console.error("Failed to fetch languages:", error);
       return failure("Failed to fetch languages");
     }
   }
   ```

Note: Make sure to add RepoListItem and ReposResponse to the import from "@/lib/github".
  </action>
  <verify>
- `npx tsc --noEmit` passes
- getRepositories and getLanguages actions are exported
  </verify>
  <done>getRepositories and getLanguages server actions added with proper auth checks</done>
</task>

<task type="auto">
  <name>Task 3: Create repository browser UI</name>
  <files>src/app/backstage/dashboard/github/page.tsx, src/app/backstage/dashboard/github/repos-browser.tsx, src/components/admin/repo-card.tsx</files>
  <action>
1. Create `src/components/admin/repo-card.tsx`:
   ```typescript
   "use client";

   // Repository card component for displaying GitHub repos
   // Shows name, description, stars, language, and selection checkbox

   import { Star, GitFork, Lock, Globe } from "lucide-react";
   import type { RepoListItem } from "@/lib/github";

   interface RepoCardProps {
     repo: RepoListItem;
     selected: boolean;
     onSelect: (repo: RepoListItem, selected: boolean) => void;
     disabled?: boolean;
   }

   export function RepoCard({ repo, selected, onSelect, disabled }: RepoCardProps) {
     return (
       <div
         className={`relative rounded-xl p-4 transition-all cursor-pointer ${
           selected ? "ring-2" : ""
         } ${disabled ? "opacity-50 cursor-not-allowed" : ""}`}
         style={{
           backgroundColor: "rgba(243, 233, 226, 0.05)",
           border: "1px solid rgba(243, 233, 226, 0.1)",
           ...(selected && { ringColor: "var(--color-primary)" }),
         }}
         onClick={() => !disabled && onSelect(repo, !selected)}
       >
         {/* Selection checkbox */}
         <div className="absolute top-4 right-4">
           <input
             type="checkbox"
             checked={selected}
             onChange={(e) => onSelect(repo, e.target.checked)}
             disabled={disabled}
             className="w-5 h-5 rounded accent-[var(--color-primary)]"
             onClick={(e) => e.stopPropagation()}
           />
         </div>

         {/* Repo name with privacy indicator */}
         <div className="flex items-center gap-2 mb-2 pr-8">
           {repo.isPrivate ? (
             <Lock size={14} style={{ color: "var(--color-text)", opacity: 0.5 }} />
           ) : (
             <Globe size={14} style={{ color: "var(--color-text)", opacity: 0.5 }} />
           )}
           <h3
             className="font-semibold truncate"
             style={{ color: "var(--color-text)" }}
           >
             {repo.name}
           </h3>
         </div>

         {/* Description */}
         <p
           className="text-sm mb-3 line-clamp-2 min-h-[2.5rem]"
           style={{ color: "var(--color-text)", opacity: 0.7 }}
         >
           {repo.description || "No description"}
         </p>

         {/* Stats row */}
         <div className="flex items-center gap-4 text-sm">
           {/* Language */}
           {repo.language && (
             <span
               className="flex items-center gap-1"
               style={{ color: "var(--color-text)", opacity: 0.6 }}
             >
               <span
                 className="w-3 h-3 rounded-full"
                 style={{ backgroundColor: "var(--color-primary)" }}
               />
               {repo.language}
             </span>
           )}

           {/* Stars */}
           <span
             className="flex items-center gap-1"
             style={{ color: "var(--color-text)", opacity: 0.6 }}
           >
             <Star size={14} />
             {repo.stars.toLocaleString()}
           </span>

           {/* Forks */}
           <span
             className="flex items-center gap-1"
             style={{ color: "var(--color-text)", opacity: 0.6 }}
           >
             <GitFork size={14} />
             {repo.forks.toLocaleString()}
           </span>
         </div>
       </div>
     );
   }
   ```

2. Create `src/app/backstage/dashboard/github/repos-browser.tsx`:
   ```typescript
   "use client";

   // Repository browser component with search, filter, and selection
   // Displays GitHub repos in a card grid with pagination

   import { useState, useEffect, useCallback } from "react";
   import { Search, Filter, Loader2, RefreshCw, Plus } from "lucide-react";
   import { toast } from "sonner";
   import { RepoCard } from "@/components/admin/repo-card";
   import { getRepositories, getLanguages } from "@/lib/actions/github";
   import type { RepoListItem } from "@/lib/github";

   const REPOS_PER_PAGE = 12;

   export function ReposBrowser() {
     // Data state
     const [repos, setRepos] = useState<RepoListItem[]>([]);
     const [languages, setLanguages] = useState<string[]>([]);
     const [totalCount, setTotalCount] = useState(0);
     const [hasMore, setHasMore] = useState(false);

     // Filter state
     const [searchQuery, setSearchQuery] = useState("");
     const [selectedLanguage, setSelectedLanguage] = useState("");
     const [currentPage, setCurrentPage] = useState(1);

     // UI state
     const [isLoading, setIsLoading] = useState(true);
     const [isLoadingMore, setIsLoadingMore] = useState(false);
     const [selectedRepos, setSelectedRepos] = useState<Set<number>>(new Set());

     // Fetch repositories
     const fetchRepos = useCallback(async (page: number, append = false) => {
       if (append) {
         setIsLoadingMore(true);
       } else {
         setIsLoading(true);
       }

       const result = await getRepositories({
         page,
         perPage: REPOS_PER_PAGE,
         query: searchQuery || undefined,
         language: selectedLanguage || undefined,
       });

       if (result.success && result.data) {
         if (append) {
           setRepos((prev) => [...prev, ...result.data!.repos]);
         } else {
           setRepos(result.data.repos);
         }
         setTotalCount(result.data.totalCount);
         setHasMore(result.data.hasMore);
       } else {
         toast.error(result.error || "Failed to fetch repositories");
       }

       setIsLoading(false);
       setIsLoadingMore(false);
     }, [searchQuery, selectedLanguage]);

     // Fetch languages for filter
     const fetchLanguages = useCallback(async () => {
       const result = await getLanguages();
       if (result.success && result.data) {
         setLanguages(result.data);
       }
     }, []);

     // Initial load
     useEffect(() => {
       fetchRepos(1);
       fetchLanguages();
     }, []);

     // Refetch when filters change
     useEffect(() => {
       setCurrentPage(1);
       fetchRepos(1);
     }, [searchQuery, selectedLanguage]);

     // Handle load more
     const handleLoadMore = () => {
       const nextPage = currentPage + 1;
       setCurrentPage(nextPage);
       fetchRepos(nextPage, true);
     };

     // Handle repo selection
     const handleRepoSelect = (repo: RepoListItem, selected: boolean) => {
       setSelectedRepos((prev) => {
         const next = new Set(prev);
         if (selected) {
           next.add(repo.id);
         } else {
           next.delete(repo.id);
         }
         return next;
       });
     };

     // Handle add selected (will be implemented in next plan)
     const handleAddSelected = () => {
       const selectedItems = repos.filter((r) => selectedRepos.has(r.id));
       toast.info(`Selected ${selectedItems.length} repos (import coming soon)`);
       // Will be replaced with actual import action in 04-04
     };

     return (
       <div className="space-y-6">
         {/* Search and Filter Bar */}
         <div className="flex flex-col sm:flex-row gap-4">
           {/* Search input */}
           <div className="relative flex-1">
             <Search
               size={18}
               className="absolute left-3 top-1/2 -translate-y-1/2"
               style={{ color: "var(--color-text)", opacity: 0.5 }}
             />
             <input
               type="text"
               placeholder="Search repositories..."
               value={searchQuery}
               onChange={(e) => setSearchQuery(e.target.value)}
               className="w-full pl-10 pr-4 py-2 rounded-lg"
               style={{
                 backgroundColor: "rgba(243, 233, 226, 0.05)",
                 border: "1px solid rgba(243, 233, 226, 0.1)",
                 color: "var(--color-text)",
               }}
             />
           </div>

           {/* Language filter */}
           <div className="relative">
             <Filter
               size={18}
               className="absolute left-3 top-1/2 -translate-y-1/2"
               style={{ color: "var(--color-text)", opacity: 0.5 }}
             />
             <select
               value={selectedLanguage}
               onChange={(e) => setSelectedLanguage(e.target.value)}
               className="pl-10 pr-8 py-2 rounded-lg appearance-none cursor-pointer"
               style={{
                 backgroundColor: "rgba(243, 233, 226, 0.05)",
                 border: "1px solid rgba(243, 233, 226, 0.1)",
                 color: "var(--color-text)",
               }}
             >
               <option value="">All Languages</option>
               {languages.map((lang) => (
                 <option key={lang} value={lang}>
                   {lang}
                 </option>
               ))}
             </select>
           </div>

           {/* Refresh button */}
           <button
             onClick={() => fetchRepos(1)}
             disabled={isLoading}
             className="px-4 py-2 rounded-lg transition-colors"
             style={{
               backgroundColor: "rgba(243, 233, 226, 0.05)",
               border: "1px solid rgba(243, 233, 226, 0.1)",
               color: "var(--color-text)",
             }}
           >
             <RefreshCw size={18} className={isLoading ? "animate-spin" : ""} />
           </button>
         </div>

         {/* Selection actions */}
         {selectedRepos.size > 0 && (
           <div
             className="flex items-center justify-between p-4 rounded-lg"
             style={{
               backgroundColor: "rgba(211, 177, 150, 0.1)",
               border: "1px solid rgba(211, 177, 150, 0.3)",
             }}
           >
             <span style={{ color: "var(--color-text)" }}>
               {selectedRepos.size} repo{selectedRepos.size === 1 ? "" : "s"} selected
             </span>
             <button
               onClick={handleAddSelected}
               className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors"
               style={{
                 backgroundColor: "var(--color-primary)",
                 color: "var(--color-background)",
               }}
             >
               <Plus size={18} />
               Add to Portfolio
             </button>
           </div>
         )}

         {/* Loading state */}
         {isLoading ? (
           <div className="flex items-center justify-center py-12">
             <Loader2
               size={32}
               className="animate-spin"
               style={{ color: "var(--color-primary)" }}
             />
           </div>
         ) : repos.length === 0 ? (
           /* Empty state */
           <div
             className="text-center py-12 rounded-xl"
             style={{
               backgroundColor: "rgba(243, 233, 226, 0.03)",
               border: "1px solid rgba(243, 233, 226, 0.1)",
             }}
           >
             <p style={{ color: "var(--color-text)", opacity: 0.6 }}>
               {searchQuery || selectedLanguage
                 ? "No repositories match your filters"
                 : "No repositories found"}
             </p>
           </div>
         ) : (
           /* Repos grid */
           <>
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
               {repos.map((repo) => (
                 <RepoCard
                   key={repo.id}
                   repo={repo}
                   selected={selectedRepos.has(repo.id)}
                   onSelect={handleRepoSelect}
                 />
               ))}
             </div>

             {/* Load more */}
             {hasMore && (
               <div className="flex justify-center pt-4">
                 <button
                   onClick={handleLoadMore}
                   disabled={isLoadingMore}
                   className="flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-colors"
                   style={{
                     backgroundColor: "rgba(243, 233, 226, 0.05)",
                     border: "1px solid rgba(243, 233, 226, 0.1)",
                     color: "var(--color-text)",
                   }}
                 >
                   {isLoadingMore ? (
                     <>
                       <Loader2 size={18} className="animate-spin" />
                       Loading...
                     </>
                   ) : (
                     "Load More"
                   )}
                 </button>
               </div>
             )}
           </>
         )}
       </div>
     );
   }
   ```

3. Update `src/app/backstage/dashboard/github/page.tsx`:
   ```typescript
   // GitHub integration page
   // Server component that loads connection status and conditionally shows repos browser

   import { getGitHubConnection } from "@/lib/actions/github";
   import { GitHubSettings } from "./github-settings";
   import { ReposBrowser } from "./repos-browser";

   export default async function GitHubPage() {
     const result = await getGitHubConnection();
     const connection = result.success ? result.data : null;

     return (
       <div className="max-w-6xl">
         <h1
           className="text-2xl font-bold mb-6"
           style={{ color: "var(--color-text)" }}
         >
           GitHub Integration
         </h1>

         <p
           className="mb-8"
           style={{ color: "var(--color-text)", opacity: 0.7 }}
         >
           Connect your GitHub account to import repositories as portfolio projects.
           Selected repos will automatically sync stars, description, and language.
         </p>

         {/* Connection settings */}
         <div className="mb-8">
           <GitHubSettings connection={connection} />
         </div>

         {/* Repository browser (only shown when connected) */}
         {connection && (
           <div className="mt-8">
             <h2
               className="text-xl font-semibold mb-4"
               style={{ color: "var(--color-text)" }}
             >
               Your Repositories
             </h2>
             <ReposBrowser />
           </div>
         )}
       </div>
     );
   }
   ```
  </action>
  <verify>
- `npm run dev` starts without errors
- Navigate to /backstage/dashboard/github (with GitHub connected)
- Repository grid loads with cards showing name, description, stars, language
- Search filters repos by name
- Language dropdown filters repos by language
- Clicking card or checkbox toggles selection
- "Add to Portfolio" button appears when repos are selected
  </verify>
  <done>Repository browser displays paginated repos in card grid with search by name and filter by language</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run dev` runs without errors
3. With GitHub connected, /backstage/dashboard/github shows:
   - Connection status card
   - "Your Repositories" heading
   - Card grid with repos (or empty state)
4. Search input filters repos by name/description
5. Language dropdown filters repos by language
6. Checkbox selection works on cards
7. "Add to Portfolio" button shows with selection count
8. "Load More" pagination works
</verification>

<success_criteria>
- Repository browser fetches repos from connected GitHub account
- Card grid displays repos with name, description, stars, forks, language, privacy indicator
- Search filters repos by name and description (client-side filter)
- Language dropdown filters repos (fetches unique languages from repos)
- Pagination with "Load More" button
- Multi-select checkboxes on cards
- Selection summary bar with count and "Add to Portfolio" button
</success_criteria>

<output>
After completion, create `.planning/phases/04-github-integration/04-03-SUMMARY.md`
</output>
