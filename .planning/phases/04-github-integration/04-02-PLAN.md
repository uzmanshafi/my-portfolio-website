---
phase: 04-github-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/auth.ts
  - src/lib/auth.config.ts
  - src/lib/actions/github.ts
  - src/app/backstage/dashboard/github/page.tsx
  - src/app/backstage/dashboard/github/github-settings.tsx
  - src/components/admin/sidebar.tsx
autonomous: true
user_setup:
  - service: github-oauth
    why: "GitHub OAuth requires app credentials for authentication"
    env_vars:
      - name: AUTH_GITHUB_ID
        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> New OAuth App -> Client ID"
      - name: AUTH_GITHUB_SECRET
        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> Generate a new client secret"
    dashboard_config:
      - task: "Create OAuth App with callback URL http://localhost:3000/api/auth/callback/github"
        location: "GitHub -> Settings -> Developer settings -> OAuth Apps"

must_haves:
  truths:
    - "Admin can initiate GitHub OAuth flow from dashboard"
    - "GitHub access token is stored encrypted in GitHubConnection table"
    - "Admin can see GitHub connection status (connected/disconnected)"
    - "Admin can disconnect GitHub account"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "GitHub OAuth provider configuration"
      contains: "GitHub("
    - path: "src/lib/actions/github.ts"
      provides: "Server actions for GitHub connection management"
      exports: ["connectGitHub", "disconnectGitHub", "getGitHubConnection"]
    - path: "src/app/backstage/dashboard/github/page.tsx"
      provides: "GitHub settings page"
      contains: "GitHubSettings"
    - path: "src/app/backstage/dashboard/github/github-settings.tsx"
      provides: "GitHub connection UI component"
      contains: "Connect GitHub"
  key_links:
    - from: "src/lib/auth.ts"
      to: "next-auth/providers/github"
      via: "import GitHub provider"
      pattern: "import GitHub from.*next-auth/providers/github"
    - from: "src/lib/actions/github.ts"
      to: "src/lib/github/encryption.ts"
      via: "encrypts token before storage"
      pattern: "encryptToken"
---

<objective>
Add GitHub OAuth provider to Auth.js and create connection management UI.

Purpose: Allow admin to connect their GitHub account, storing the access token securely for API access.
Output: GitHub OAuth flow working, connection status visible in dashboard, connect/disconnect functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-github-integration/04-RESEARCH.md
@.planning/phases/04-github-integration/04-01-SUMMARY.md

# Existing files to reference
@src/lib/auth.ts
@src/lib/auth.config.ts
@src/components/admin/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GitHub OAuth provider to Auth.js</name>
  <files>src/lib/auth.ts, src/lib/auth.config.ts</files>
  <action>
1. Update `src/lib/auth.config.ts` to add GitHub provider stub (for Edge compatibility):
   - Add GitHub to providers array with empty config (no authorize logic)
   - Keep existing Credentials provider

2. Update `src/lib/auth.ts` to configure GitHub OAuth:
   ```typescript
   import GitHub from 'next-auth/providers/github';
   ```

   Add GitHub provider to providers array:
   ```typescript
   GitHub({
     clientId: process.env.AUTH_GITHUB_ID,
     clientSecret: process.env.AUTH_GITHUB_SECRET,
     authorization: {
       params: {
         // Request repo scope to access private repos
         scope: 'read:user user:email repo',
       },
     },
   }),
   ```

3. Extend JWT callback to capture GitHub access token:
   ```typescript
   jwt: async ({ token, user, account }) => {
     // Existing user logic...
     if (user) {
       token.id = user.id;
       token.email = user.email;
       token.name = user.name;
     }
     // Capture GitHub token on OAuth login
     if (account?.provider === 'github') {
       token.githubAccessToken = account.access_token;
       token.githubUsername = account.providerAccountId;
     }
     return token;
   },
   ```

4. Extend session callback to expose GitHub connection status:
   ```typescript
   session: async ({ session, token }) => {
     // Existing session logic...
     if (token && session.user) {
       session.user.id = token.id as string;
       session.user.email = token.email as string;
       session.user.name = token.name as string;
     }
     // Expose GitHub connection status
     (session as any).githubConnected = !!token.githubAccessToken;
     return session;
   },
   ```

5. Add event callback to store GitHub token in database on link:
   ```typescript
   events: {
     async linkAccount({ account }) {
       if (account.provider === 'github' && account.access_token) {
         // Import and call the connection action
         const { storeGitHubConnection } = await import('@/lib/actions/github');
         await storeGitHubConnection(account.access_token, account.providerAccountId);
       }
     },
   },
   ```

NOTE: The linkAccount event fires when a GitHub account is linked to an existing session. This happens after the admin logs in with credentials and then connects GitHub.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Auth.js config includes GitHub provider
  </verify>
  <done>GitHub OAuth provider configured with repo scope, JWT captures access token, linkAccount event stores token</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub connection server actions</name>
  <files>src/lib/actions/github.ts</files>
  <action>
1. Create `src/lib/actions/github.ts`:
   ```typescript
   "use server";

   // Server actions for GitHub connection management
   // These actions manage the GitHubConnection record in the database

   import { auth } from "@/lib/auth";
   import { prisma } from "@/lib/prisma";
   import { encryptToken, decryptToken, createGitHubClient } from "@/lib/github";
   import type { ActionResult } from "@/lib/validations/common";
   import { success, failure } from "@/lib/validations/common";
   import type { GitHubConnection } from "@/generated/prisma/client";

   /**
    * Get the current GitHub connection status.
    * Returns the connection record if exists, null otherwise.
    */
   export async function getGitHubConnection(): Promise<ActionResult<GitHubConnection | null>> {
     const session = await auth();
     if (!session?.user) {
       return failure("Unauthorized");
     }

     try {
       // Only one connection allowed (single admin)
       const connection = await prisma.gitHubConnection.findFirst();
       return success(connection);
     } catch (error) {
       console.error("Failed to get GitHub connection:", error);
       return failure("Failed to get GitHub connection");
     }
   }

   /**
    * Store GitHub connection after OAuth callback.
    * Called from Auth.js linkAccount event.
    * @internal - Not meant to be called directly from UI
    */
   export async function storeGitHubConnection(
     accessToken: string,
     providerAccountId: string
   ): Promise<ActionResult<GitHubConnection>> {
     try {
       // Encrypt the access token before storing
       const encryptedToken = await encryptToken(accessToken);

       // Get user info from GitHub to store username
       const octokit = createGitHubClient(accessToken);
       const { data: user } = await octokit.rest.users.getAuthenticated();

       // Upsert connection (replace existing if any)
       const connection = await prisma.gitHubConnection.upsert({
         where: { id: "github-connection" }, // Use fixed ID for singleton
         update: {
           accessToken: encryptedToken,
           username: user.login,
           avatarUrl: user.avatar_url,
           connectedAt: new Date(),
           syncError: null,
         },
         create: {
           id: "github-connection",
           accessToken: encryptedToken,
           username: user.login,
           avatarUrl: user.avatar_url,
         },
       });

       return success(connection);
     } catch (error) {
       console.error("Failed to store GitHub connection:", error);
       return failure("Failed to store GitHub connection");
     }
   }

   /**
    * Disconnect GitHub account.
    * Removes the stored token but keeps synced projects intact.
    */
   export async function disconnectGitHub(): Promise<ActionResult> {
     const session = await auth();
     if (!session?.user) {
       return failure("Unauthorized");
     }

     try {
       await prisma.gitHubConnection.deleteMany();
       return success();
     } catch (error) {
       console.error("Failed to disconnect GitHub:", error);
       return failure("Failed to disconnect GitHub");
     }
   }

   /**
    * Get the decrypted access token for API calls.
    * @internal - Used by other GitHub actions, not exposed to client
    */
   export async function getGitHubAccessToken(): Promise<string | null> {
     try {
       const connection = await prisma.gitHubConnection.findFirst();
       if (!connection) {
         return null;
       }
       return await decryptToken(connection.accessToken);
     } catch (error) {
       console.error("Failed to get GitHub access token:", error);
       return null;
     }
   }
   ```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Server actions export getGitHubConnection, disconnectGitHub, storeGitHubConnection
  </verify>
  <done>GitHub connection server actions created with encryption, singleton pattern for connection</done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub settings page and UI</name>
  <files>src/app/backstage/dashboard/github/page.tsx, src/app/backstage/dashboard/github/github-settings.tsx, src/components/admin/sidebar.tsx</files>
  <action>
1. Create `src/app/backstage/dashboard/github/page.tsx`:
   ```typescript
   // GitHub integration settings page
   // Server component that loads connection status

   import { getGitHubConnection } from "@/lib/actions/github";
   import { GitHubSettings } from "./github-settings";

   export default async function GitHubPage() {
     const result = await getGitHubConnection();
     const connection = result.success ? result.data : null;

     return (
       <div className="max-w-4xl">
         <h1
           className="text-2xl font-bold mb-6"
           style={{ color: "var(--color-text)" }}
         >
           GitHub Integration
         </h1>

         <p
           className="mb-8"
           style={{ color: "var(--color-text)", opacity: 0.7 }}
         >
           Connect your GitHub account to import repositories as portfolio projects.
           Selected repos will automatically sync stars, description, and language.
         </p>

         <GitHubSettings connection={connection} />
       </div>
     );
   }
   ```

2. Create `src/app/backstage/dashboard/github/github-settings.tsx`:
   ```typescript
   "use client";

   // Client component for GitHub connection management
   // Shows connect/disconnect button and connection status

   import { useState } from "react";
   import { signIn } from "next-auth/react";
   import { Github, Unlink, Loader2, CheckCircle } from "lucide-react";
   import { toast } from "sonner";
   import { disconnectGitHub } from "@/lib/actions/github";
   import type { GitHubConnection } from "@/generated/prisma/client";

   interface GitHubSettingsProps {
     connection: GitHubConnection | null;
   }

   export function GitHubSettings({ connection }: GitHubSettingsProps) {
     const [isConnecting, setIsConnecting] = useState(false);
     const [isDisconnecting, setIsDisconnecting] = useState(false);

     // Handle connect - redirects to GitHub OAuth
     const handleConnect = async () => {
       setIsConnecting(true);
       try {
         // Use signIn to trigger GitHub OAuth flow
         // redirect: false prevents full page reload, we handle it manually
         await signIn("github", {
           callbackUrl: "/backstage/dashboard/github",
         });
       } catch (error) {
         console.error("Failed to connect GitHub:", error);
         toast.error("Failed to connect GitHub");
         setIsConnecting(false);
       }
     };

     // Handle disconnect
     const handleDisconnect = async () => {
       setIsDisconnecting(true);
       const result = await disconnectGitHub();

       if (result.success) {
         toast.success("GitHub disconnected");
         // Reload to refresh connection status
         window.location.reload();
       } else {
         toast.error(result.error || "Failed to disconnect");
         setIsDisconnecting(false);
       }
     };

     return (
       <div
         className="rounded-xl p-6"
         style={{
           backgroundColor: "rgba(243, 233, 226, 0.05)",
           border: "1px solid rgba(243, 233, 226, 0.1)",
         }}
       >
         <h2
           className="text-lg font-semibold mb-4 flex items-center gap-2"
           style={{ color: "var(--color-text)" }}
         >
           <Github size={20} />
           GitHub Account
         </h2>

         {connection ? (
           // Connected state
           <div className="space-y-4">
             <div className="flex items-center gap-3">
               {connection.avatarUrl && (
                 <img
                   src={connection.avatarUrl}
                   alt={connection.username}
                   className="w-10 h-10 rounded-full"
                 />
               )}
               <div>
                 <p
                   className="font-medium"
                   style={{ color: "var(--color-text)" }}
                 >
                   {connection.username}
                 </p>
                 <p
                   className="text-sm flex items-center gap-1"
                   style={{ color: "var(--color-text)", opacity: 0.6 }}
                 >
                   <CheckCircle size={14} className="text-green-500" />
                   Connected
                 </p>
               </div>
             </div>

             {connection.lastSyncAt && (
               <p
                 className="text-sm"
                 style={{ color: "var(--color-text)", opacity: 0.5 }}
               >
                 Last synced: {new Date(connection.lastSyncAt).toLocaleDateString()}
               </p>
             )}

             {connection.syncError && (
               <p
                 className="text-sm px-3 py-2 rounded-lg"
                 style={{
                   backgroundColor: "rgba(239, 68, 68, 0.1)",
                   color: "#ef4444",
                 }}
               >
                 Sync error: {connection.syncError}
               </p>
             )}

             <button
               onClick={handleDisconnect}
               disabled={isDisconnecting}
               className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors"
               style={{
                 backgroundColor: "transparent",
                 color: "var(--color-text)",
                 border: "1px solid rgba(243, 233, 226, 0.3)",
                 opacity: isDisconnecting ? 0.7 : 1,
               }}
             >
               {isDisconnecting ? (
                 <>
                   <Loader2 size={18} className="animate-spin" />
                   Disconnecting...
                 </>
               ) : (
                 <>
                   <Unlink size={18} />
                   Disconnect GitHub
                 </>
               )}
             </button>
           </div>
         ) : (
           // Disconnected state
           <div className="space-y-4">
             <p
               className="text-sm"
               style={{ color: "var(--color-text)", opacity: 0.6 }}
             >
               Connect your GitHub account to browse and import your repositories.
             </p>

             <button
               onClick={handleConnect}
               disabled={isConnecting}
               className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors"
               style={{
                 backgroundColor: "var(--color-primary)",
                 color: "var(--color-background)",
                 opacity: isConnecting ? 0.7 : 1,
               }}
             >
               {isConnecting ? (
                 <>
                   <Loader2 size={18} className="animate-spin" />
                   Connecting...
                 </>
               ) : (
                 <>
                   <Github size={18} />
                   Connect GitHub
                 </>
               )}
             </button>
           </div>
         )}
       </div>
     );
   }
   ```

3. Update `src/components/admin/sidebar.tsx` to add GitHub nav item:
   - Add GitHub icon import from lucide-react
   - Add new nav item after "Contact" and before logout:
     ```typescript
     { name: "GitHub", href: "/backstage/dashboard/github", icon: Github },
     ```
  </action>
  <verify>
- `npm run dev` starts without errors
- Navigate to /backstage/dashboard/github shows the page
- "GitHub" appears in sidebar navigation
- Connect button is visible when not connected
  </verify>
  <done>GitHub settings page shows connection status, Connect/Disconnect buttons work, sidebar has GitHub link</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes - no TypeScript errors
2. `npm run dev` runs without errors
3. Navigate to /backstage/dashboard/github:
   - Page loads showing "GitHub Integration" heading
   - "Connect GitHub" button appears (when not connected)
4. Sidebar shows "GitHub" navigation item
5. Clicking "Connect GitHub" redirects to GitHub OAuth (will fail without env vars configured)
</verification>

<success_criteria>
- GitHub OAuth provider added to Auth.js with read:user, user:email, repo scopes
- linkAccount event stores encrypted token in GitHubConnection table
- /backstage/dashboard/github page shows connection status
- "Connect GitHub" button triggers OAuth flow
- "Disconnect GitHub" button removes connection and refreshes page
- Sidebar includes GitHub navigation link
</success_criteria>

<output>
After completion, create `.planning/phases/04-github-integration/04-02-SUMMARY.md`
</output>
