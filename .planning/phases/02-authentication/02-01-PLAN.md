---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/auth.config.ts
  - src/lib/auth.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - scripts/hash-password.ts
  - .env.local
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Auth.js v5 is configured with JWT session strategy"
    - "Credentials provider validates against env-stored admin credentials"
    - "Auth route handlers respond to /api/auth/* requests"
    - "Password hash can be generated for .env configuration"
  artifacts:
    - path: "src/lib/auth.config.ts"
      provides: "Edge-compatible Auth.js configuration"
      contains: "authConfig"
    - path: "src/lib/auth.ts"
      provides: "Full Auth.js config with authorize logic"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js route handlers"
      exports: ["GET", "POST"]
    - path: "scripts/hash-password.ts"
      provides: "Password hash generation utility"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/auth.config.ts"
      via: "spread operator"
      pattern: "\\.\\.\\.(auth|config)"
    - from: "src/app/api/auth/[...nextauth]/route.ts"
      to: "src/lib/auth.ts"
      via: "import handlers"
      pattern: "import.*handlers.*from.*auth"
---

<objective>
Configure Auth.js v5 with Credentials provider for admin authentication

Purpose: Establish the authentication foundation using Auth.js v5 split configuration pattern for Edge Runtime compatibility. The credentials provider validates against environment-stored admin credentials using argon2 password hashing.

Output: Working Auth.js configuration, route handlers, and password hash generation script
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@src/lib/prisma.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Auth.js dependencies and create split configuration</name>
  <files>
    package.json
    src/lib/auth.config.ts
    src/lib/auth.ts
  </files>
  <action>
Install Auth.js v5 and supporting packages:
```bash
npm install next-auth@beta jose argon2 zod sonner lucide-react
```

Create Edge-compatible configuration at src/lib/auth.config.ts:
- Export `authConfig` satisfying `NextAuthConfig` type
- Configure pages.signIn to "/backstage"
- Define Credentials provider skeleton (credentials object only, no authorize)
- Implement `authorized` callback:
  - Check if path starts with "/backstage"
  - Check if path equals "/backstage" (login page)
  - Return true for login page (allow all)
  - Return isLoggedIn for other backstage routes (triggers middleware handling)
  - Return true for all other routes

Create full configuration at src/lib/auth.ts:
- Import and spread authConfig
- Configure session.strategy as "jwt"
- Configure session.maxAge as 7 * 24 * 60 * 60 (7 days default)
- Override Credentials provider with authorize function:
  - Validate email matches process.env.ADMIN_EMAIL
  - Verify password against process.env.ADMIN_PASSWORD_HASH using argon2.verify()
  - Return null on invalid credentials
  - Return { id: "admin", email: ADMIN_EMAIL, name: "Admin" } on success
- Implement jwt callback to persist user data to token
- Implement session callback to expose user data from token
- Export { handlers, auth, signIn, signOut } from NextAuth()

IMPORTANT: Do NOT use database adapter - this uses JWT-only strategy with env credentials.
  </action>
  <verify>
- TypeScript compilation succeeds: `npx tsc --noEmit`
- Imports resolve correctly
  </verify>
  <done>Auth.js configuration files exist with proper typing and Edge/full split</done>
</task>

<task type="auto">
  <name>Task 2: Create Auth.js route handlers and password hash script</name>
  <files>
    src/app/api/auth/[...nextauth]/route.ts
    scripts/hash-password.ts
  </files>
  <action>
Create route handler at src/app/api/auth/[...nextauth]/route.ts:
```typescript
import { handlers } from "@/lib/auth";
export const { GET, POST } = handlers;
```

Create password hash generation script at scripts/hash-password.ts:
- Import argon2
- Define async hashPassword(password: string) function
- Use argon2.hash() with argon2id variant:
  - memoryCost: 65536 (64 MB)
  - timeCost: 3
  - parallelism: 4
- Log the hash in format: ADMIN_PASSWORD_HASH=<hash>
- Read password from command line arg (process.argv[2])
- If no arg provided, log usage instructions and exit

Add npm script to package.json:
```json
"hash-password": "tsx scripts/hash-password.ts"
```
  </action>
  <verify>
- Route handler file exists and exports GET, POST
- Hash script runs: `npm run hash-password testpassword` outputs a hash starting with $argon2id$
  </verify>
  <done>Route handlers respond to /api/auth/* and password hash script generates argon2id hashes</done>
</task>

<task type="auto">
  <name>Task 3: Configure environment variables for auth</name>
  <files>
    .env.local
    .env.example
  </files>
  <action>
Generate AUTH_SECRET:
```bash
openssl rand -base64 32
```

Generate a test password hash using the script from Task 2:
```bash
npm run hash-password "your-secure-admin-password"
```

Update .env.local with:
- AUTH_SECRET=<generated-secret>
- ADMIN_EMAIL=admin@example.com (or user's preferred email)
- ADMIN_PASSWORD_HASH=<generated-hash>

Update .env.example with placeholder structure:
- AUTH_SECRET=your-auth-secret-here-generate-with-openssl-rand-base64-32
- ADMIN_EMAIL=admin@example.com
- ADMIN_PASSWORD_HASH=generate-with-npm-run-hash-password

Note: For testing, use a known password like "admin123" and its hash. The user can change this later.
  </action>
  <verify>
- .env.local contains AUTH_SECRET, ADMIN_EMAIL, ADMIN_PASSWORD_HASH
- .env.example documents all required auth variables
- TypeScript compilation still succeeds after env changes
  </verify>
  <done>Environment variables configured for authentication with secure defaults</done>
</task>

</tasks>

<verification>
Run these checks to verify the plan:

1. Package installation:
   ```bash
   npm ls next-auth jose argon2 zod sonner lucide-react
   ```
   All packages should be listed.

2. TypeScript compilation:
   ```bash
   npx tsc --noEmit
   ```
   Should complete with no errors.

3. Password hash generation:
   ```bash
   npm run hash-password testpass
   ```
   Should output: ADMIN_PASSWORD_HASH=$argon2id$...

4. Development server starts:
   ```bash
   npm run dev
   ```
   Should start without auth-related errors.
</verification>

<success_criteria>
- Auth.js v5 beta installed with supporting packages
- Split configuration pattern implemented (auth.config.ts + auth.ts)
- Credentials provider configured with argon2 password verification
- Route handlers export GET and POST at /api/auth/[...nextauth]
- Password hash script generates argon2id hashes
- Environment variables configured in .env.local and documented in .env.example
- TypeScript compilation succeeds
- Development server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
