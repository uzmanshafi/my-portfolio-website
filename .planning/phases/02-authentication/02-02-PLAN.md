---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - middleware.ts
  - src/lib/actions/auth.ts
  - src/app/backstage/page.tsx
  - src/app/backstage/layout.tsx
  - src/app/backstage/components/login-form.tsx
  - src/app/backstage/dashboard/layout.tsx
  - src/app/backstage/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can log in with email and password"
    - "Unauthenticated users see 404 when accessing /backstage/* routes"
    - "Authenticated users are redirected from login page to dashboard"
    - "Admin can access dashboard after successful login"
    - "Login page matches dark theme design"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection with 404 for unauthenticated access"
      contains: "matcher"
    - path: "src/lib/actions/auth.ts"
      provides: "Server actions for login/logout"
      exports: ["login", "logout"]
    - path: "src/app/backstage/page.tsx"
      provides: "Login page"
    - path: "src/app/backstage/components/login-form.tsx"
      provides: "Login form component with password toggle and loading state"
    - path: "src/app/backstage/dashboard/page.tsx"
      provides: "Dashboard home page"
  key_links:
    - from: "middleware.ts"
      to: "src/lib/auth.config.ts"
      via: "import authConfig"
      pattern: "import.*authConfig"
    - from: "src/app/backstage/components/login-form.tsx"
      to: "src/lib/actions/auth.ts"
      via: "useActionState"
      pattern: "useActionState.*login"
    - from: "src/app/backstage/dashboard/layout.tsx"
      to: "src/lib/auth.ts"
      via: "auth() session check"
      pattern: "auth\\(\\)"
---

<objective>
Implement route protection, login UI, and dashboard structure

Purpose: Create the user-facing authentication flow with middleware protection that returns 404 for unauthenticated access (hiding admin routes), a styled login page at /backstage with split layout, and protected dashboard structure at /backstage/dashboard.

Output: Working login flow where admin can authenticate and access the dashboard
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@src/lib/auth.ts
@src/lib/auth.config.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for route protection with 404</name>
  <files>
    middleware.ts
    src/app/not-found.tsx
  </files>
  <action>
Create middleware.ts at project root (NOT in src/):

```typescript
import NextAuth from "next-auth";
import { authConfig } from "@/lib/auth.config";
import { NextResponse } from "next/server";

const { auth } = NextAuth(authConfig);

export default auth((req) => {
  const isBackstage = req.nextUrl.pathname.startsWith("/backstage");
  const isLoginPage = req.nextUrl.pathname === "/backstage";
  const isLoggedIn = !!req.auth;

  // Login page: redirect to dashboard if already logged in
  if (isLoginPage && isLoggedIn) {
    return NextResponse.redirect(new URL("/backstage/dashboard", req.url));
  }

  // Protected routes: return 404 if not logged in (hide admin existence)
  if (isBackstage && !isLoginPage && !isLoggedIn) {
    // Rewrite to not-found page (pretend route doesn't exist)
    return NextResponse.rewrite(new URL("/not-found", req.url));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ["/backstage/:path*"],
};
```

Update src/app/not-found.tsx to ensure it works as rewrite target:
- Keep existing styling consistent with dark theme
- Ensure it returns proper 404 status
  </action>
  <verify>
- Start dev server: `npm run dev`
- Visit http://localhost:3000/backstage/dashboard (not logged in) - should see 404 page
- Visit http://localhost:3000/backstage - should see login page (will create in next task)
  </verify>
  <done>Middleware protects /backstage/* routes by returning 404 for unauthenticated access</done>
</task>

<task type="auto">
  <name>Task 2: Create login server action and login page</name>
  <files>
    src/lib/actions/auth.ts
    src/app/backstage/layout.tsx
    src/app/backstage/page.tsx
    src/app/backstage/components/login-form.tsx
  </files>
  <action>
Create server action at src/lib/actions/auth.ts:

```typescript
"use server";

import { signIn, signOut } from "@/lib/auth";
import { AuthError } from "next-auth";
import { redirect } from "next/navigation";

export type LoginState = {
  error?: string;
} | null;

export async function login(
  prevState: LoginState,
  formData: FormData
): Promise<LoginState> {
  try {
    await signIn("credentials", {
      email: formData.get("email"),
      password: formData.get("password"),
      redirect: false,
    });
  } catch (error) {
    if (error instanceof AuthError) {
      switch (error.type) {
        case "CredentialsSignin":
          return { error: "Invalid email or password" };
        default:
          return { error: "Something went wrong. Please try again." };
      }
    }
    throw error;
  }
  redirect("/backstage/dashboard");
}

export async function logout() {
  await signOut({ redirectTo: "/backstage" });
}
```

Create backstage layout at src/app/backstage/layout.tsx:
- Simple wrapper layout for the backstage section
- No session provider here (that's for dashboard layout)

Create login form component at src/app/backstage/components/login-form.tsx:
- Use "use client" directive
- Use useActionState hook with login action
- Include email input (type="email", required)
- Include password input with visibility toggle (Eye/EyeOff icons from lucide-react)
- Show error message if state.error exists (red banner at top)
- Disable form and show Loader2 spinner during submission (isPending)
- Style to match dark theme:
  - Background: var(--color-background) or #160f09
  - Text: var(--color-text) or #f3e9e2
  - Primary button: var(--color-primary) or #d3b196
  - Focus rings using accent color

Create login page at src/app/backstage/page.tsx:
- Split layout: login form on left, portfolio preview on right
- Use grid or flex to create two-column layout
- Left side: centered LoginForm component
- Right side: subtle portfolio preview (can be placeholder gradient or abstract pattern for now)
- Full viewport height (min-h-screen)
- Match dark theme colors from globals.css
  </action>
  <verify>
- Start dev server: `npm run dev`
- Visit http://localhost:3000/backstage - login page renders with form
- Form has email, password (with toggle), and submit button
- Submitting invalid credentials shows error message
- Submitting valid credentials (from .env.local) redirects to /backstage/dashboard
  </verify>
  <done>Login page renders at /backstage with functional authentication form</done>
</task>

<task type="auto">
  <name>Task 3: Create protected dashboard structure with logout</name>
  <files>
    src/app/backstage/dashboard/layout.tsx
    src/app/backstage/dashboard/page.tsx
    src/app/backstage/dashboard/components/logout-button.tsx
  </files>
  <action>
Create dashboard layout at src/app/backstage/dashboard/layout.tsx:
- Server component that checks session using auth()
- If no session, redirect to /backstage (login page)
- Wrap children in SessionProvider from "next-auth/react"
- Include basic admin shell structure:
  - Header with "Backstage" title and logout button
  - Main content area for children
- Style to match dark theme

Create logout button component at src/app/backstage/dashboard/components/logout-button.tsx:
- "use client" directive
- Import logout from "@/lib/actions/auth"
- Use useTransition for pending state
- Button that calls logout action
- Show loading state during logout

Create dashboard page at src/app/backstage/dashboard/page.tsx:
- Server component
- Get session using auth()
- Display welcome message: "Welcome back, {session.user.email}"
- Placeholder content: "Dashboard content coming in Phase 3"
- This is a placeholder until Phase 3 builds the actual admin dashboard

Verify layered defense is working:
- Layer 1: Middleware (route-level) - already done in Task 1
- Layer 2: Dashboard layout (session check before render)
- Layer 3: Individual actions will check auth (pattern established, used in Phase 3)
  </action>
  <verify>
- After logging in, dashboard page shows welcome message
- Logout button clears session and redirects to login page
- After logout, visiting /backstage/dashboard shows 404 (not redirect)
- Refreshing dashboard page while logged in keeps user authenticated (session persists)
  </verify>
  <done>Dashboard is protected with layered defense and logout functionality works</done>
</task>

</tasks>

<verification>
Run these checks to verify the complete authentication flow:

1. Unauthenticated access:
   ```
   Visit http://localhost:3000/backstage/dashboard
   ```
   Should see 404 page (route hidden).

2. Login page access:
   ```
   Visit http://localhost:3000/backstage
   ```
   Should see styled login page with split layout.

3. Invalid login:
   ```
   Enter wrong credentials and submit
   ```
   Should see error message, stay on login page.

4. Valid login:
   ```
   Enter credentials from .env.local (ADMIN_EMAIL + password that matches ADMIN_PASSWORD_HASH)
   ```
   Should redirect to /backstage/dashboard with welcome message.

5. Session persistence:
   ```
   Refresh the dashboard page
   Close and reopen browser tab
   ```
   Should remain logged in (7-day session by default).

6. Logout:
   ```
   Click logout button
   ```
   Should redirect to login page. Visiting /backstage/dashboard now shows 404.

7. Already logged in:
   ```
   Log in, then visit /backstage directly
   ```
   Should redirect to /backstage/dashboard.
</verification>

<success_criteria>
- Middleware intercepts /backstage/* routes
- Unauthenticated access to protected routes returns 404 (not redirect)
- Login page renders at /backstage with split layout design
- Login form has email and password with visibility toggle
- Invalid credentials show error message
- Valid credentials redirect to dashboard
- Dashboard shows welcome message with user email
- Logout clears session and redirects to login
- Session persists across page refresh
- Already-authenticated users redirected from login to dashboard
- All UI matches dark theme colors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
