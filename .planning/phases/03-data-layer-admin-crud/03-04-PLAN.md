---
phase: 03-data-layer-admin-crud
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/validations/project.ts
  - src/lib/actions/projects.ts
  - src/components/admin/sortable-project-item.tsx
  - src/components/admin/project-form-modal.tsx
  - src/app/backstage/dashboard/projects/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create projects with name, description, image, and links"
    - "Admin can edit existing project details"
    - "Admin can delete projects with confirmation"
    - "Admin can reorder projects via drag-and-drop"
    - "Admin can toggle project visibility (show/hide)"
    - "Reorder persists immediately with optimistic update"
  artifacts:
    - path: "src/lib/validations/project.ts"
      provides: "Zod schema for project validation"
      exports: ["projectSchema", "ProjectFormData"]
    - path: "src/lib/actions/projects.ts"
      provides: "Server actions for projects CRUD and reordering"
      exports: ["getProjects", "createProject", "updateProject", "deleteProject", "updateProjectsOrder", "toggleProjectVisibility"]
    - path: "src/components/admin/sortable-project-item.tsx"
      provides: "Draggable project card component"
      exports: ["SortableProjectItem"]
    - path: "src/components/admin/project-form-modal.tsx"
      provides: "Modal form for create/edit project"
      exports: ["ProjectFormModal"]
    - path: "src/app/backstage/dashboard/projects/page.tsx"
      provides: "Projects management page"
  key_links:
    - from: "src/app/backstage/dashboard/projects/page.tsx"
      to: "@dnd-kit/core"
      via: "DndContext for drag-and-drop"
      pattern: "DndContext"
    - from: "src/components/admin/project-form-modal.tsx"
      to: "src/lib/actions/projects.ts"
      via: "form submission"
      pattern: "createProject|updateProject"
---

<objective>
Build the Projects section with full CRUD operations, drag-and-drop reordering, and visibility toggle.

Purpose: Allow admin to manage portfolio projects - add new projects manually, edit details, control display order, and toggle visibility without deleting.

Output: Functional projects management page with drag-and-drop reordering and visibility controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-data-layer-admin-crud/03-CONTEXT.md
@.planning/phases/03-data-layer-admin-crud/03-RESEARCH.md
@prisma/schema.prisma
@src/lib/actions/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project validation and server actions</name>
  <files>
    - src/lib/validations/project.ts
    - src/lib/actions/projects.ts
  </files>
  <action>
Create `src/lib/validations/project.ts`:
- Zod schema with fields:
  - title (required, 1-100 chars)
  - description (required, min 10 chars)
  - imageUrl (optional, valid URL or empty)
  - liveUrl (optional, valid URL or empty)
  - repoUrl (optional, valid URL or empty)
  - technologies (optional, array of strings)
  - featured (optional, boolean, default false)
- Export `projectSchema`, `ProjectFormData`

Create `src/lib/actions/projects.ts`:
- "use server"
- Import prisma, auth, revalidatePath

Actions:
- `getProjects()`: Fetch all projects ordered by order field. Include hidden projects for admin view.
- `createProject(formData: FormData)`: Validate, create with order = max order + 1, visible = true. Return ActionResult with created project.
- `updateProject(id: string, formData: FormData)`: Validate and update project fields.
- `deleteProject(id: string)`: Delete project by ID.
- `updateProjectsOrder(updates: { id: string; order: number }[])`: Bulk update order. Use prisma.$transaction.
- `toggleProjectVisibility(id: string)`: Toggle the visible boolean field.
- `updateProjectImage(id: string, imageUrl: string)`: Update only the imageUrl field (called after upload).

All actions check auth first.
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
  </verify>
  <done>
Project validation and server actions ready for CRUD, reordering, and visibility toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create project form modal and sortable item</name>
  <files>
    - src/components/admin/project-form-modal.tsx
    - src/components/admin/sortable-project-item.tsx
  </files>
  <action>
Create `src/components/admin/project-form-modal.tsx`:
- "use client"
- Props: isOpen, onClose, project (optional for edit mode), onSuccess
- Use react-hook-form with zodResolver(projectSchema)
- Fields:
  - Title (text input)
  - Description (textarea)
  - Image upload (click to select, shows preview, uploads to Supabase via signed URL)
  - Live URL (text input, optional)
  - Repository URL (text input, optional)
  - Technologies (comma-separated input or tag input)
  - Featured checkbox
- Validate on blur, show errors
- Submit button: "Create Project" or "Save Changes"
- Loading state during submission
- On success: close modal, call onSuccess callback
- Modal overlay with focus trap

Create `src/components/admin/sortable-project-item.tsx`:
- "use client"
- Use useSortable from @dnd-kit/sortable
- Props: project object, onEdit, onDelete, onToggleVisibility
- Display as card:
  - Drag handle (GripVertical icon)
  - Project thumbnail (or placeholder)
  - Title and truncated description
  - Visibility toggle (Eye/EyeOff icon) - click toggles
  - Edit button, Delete button
- Visual indication when hidden (opacity, strikethrough, or badge)
- Drag feedback (opacity, shadow)
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
  </verify>
  <done>
Project form modal handles create/edit with validation and image upload. Sortable item shows project card with all controls.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build projects management page</name>
  <files>
    - src/app/backstage/dashboard/projects/page.tsx
  </files>
  <action>
Create `src/app/backstage/dashboard/projects/page.tsx`:

Server component wrapper:
- Fetch projects with getProjects()
- Pass to client ProjectsManager component

Client ProjectsManager component:
- "use client"
- DndContext with closestCenter collision detection
- SortableContext with verticalListSortingStrategy
- Sensors: PointerSensor and KeyboardSensor

Page layout:
- Header with title "Projects" and "Add Project" button
- List of SortableProjectItem components
- Empty state if no projects

Add/Edit Project:
- "Add Project" button opens ProjectFormModal
- Edit button on item opens ProjectFormModal with project data

Delete Project:
- Delete button shows confirmation dialog
- On confirm: call deleteProject, show toast

Toggle Visibility:
- Click eye icon: call toggleProjectVisibility
- Use useOptimistic for instant toggle
- Show toast on toggle

Reorder:
- On drag end: calculate new orders, call updateProjectsOrder
- Use useOptimistic (wrapped in startTransition)
- On error: revert state, show error toast

Filter/view options (optional, Claude's discretion):
- Toggle to show/hide hidden projects
- Currently all projects shown in admin view
  </action>
  <verify>
- Visit `/backstage/dashboard/projects` - page loads
- Add project: modal opens, create works, appears in list
- Edit project: modal pre-fills, updates work
- Delete project: confirmation, then removed
- Toggle visibility: instant visual feedback, persists
- Drag reorder: instant feedback, persists on refresh
- Upload project image: uploads to Supabase, shows in card
  </verify>
  <done>
Projects section complete: full CRUD, drag-and-drop reordering, visibility toggle, image upload.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/backstage/dashboard/projects`
2. Add a project with all fields including image
3. Add another project
4. Drag to reorder - instant feedback
5. Refresh - order persists
6. Toggle visibility on a project - visual change
7. Edit a project - changes save
8. Delete a project - removed after confirmation
</verification>

<success_criteria>
- Projects CRUD operations work with validation
- Image upload works via Supabase signed URL
- Drag-and-drop reorders projects globally
- Visibility toggle works with immediate feedback
- Optimistic updates provide instant UI response
- Hidden projects visually distinct but visible to admin
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer-admin-crud/03-04-SUMMARY.md`
</output>
