---
phase: 03-data-layer-admin-crud
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/validations/skill.ts
  - src/lib/actions/skills.ts
  - src/components/admin/sortable-skill-item.tsx
  - src/components/admin/skill-category.tsx
  - src/app/backstage/dashboard/skills/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can add new skills with name, icon, and category"
    - "Admin can remove skills with confirmation"
    - "Admin can reorder skills within a category via drag-and-drop"
    - "Admin can reorder categories themselves"
    - "Reorder persists immediately with optimistic update"
    - "Skills are grouped by category in the UI"
  artifacts:
    - path: "src/lib/validations/skill.ts"
      provides: "Zod schema for skill validation"
      exports: ["skillSchema", "SkillFormData"]
    - path: "src/lib/actions/skills.ts"
      provides: "Server actions for skills CRUD and reordering"
      exports: ["getSkills", "createSkill", "updateSkill", "deleteSkill", "updateSkillsOrder", "updateCategoryOrder"]
    - path: "src/components/admin/sortable-skill-item.tsx"
      provides: "Draggable skill item component"
      exports: ["SortableSkillItem"]
    - path: "src/components/admin/skill-category.tsx"
      provides: "Category container with sortable skills"
      exports: ["SkillCategory"]
    - path: "src/app/backstage/dashboard/skills/page.tsx"
      provides: "Skills management page"
  key_links:
    - from: "src/app/backstage/dashboard/skills/page.tsx"
      to: "@dnd-kit/core"
      via: "DndContext for drag-and-drop"
      pattern: "DndContext"
    - from: "src/components/admin/skill-category.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext for list"
      pattern: "SortableContext"
---

<objective>
Build the Skills section with full CRUD operations and drag-and-drop reordering within categories, plus category reordering.

Purpose: Allow admin to manage skills list - add new skills with icons, remove skills, organize by category, and control display order through intuitive drag-and-drop.

Output: Functional skills management page with category grouping and immediate-persist drag-and-drop reordering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-data-layer-admin-crud/03-CONTEXT.md
@.planning/phases/03-data-layer-admin-crud/03-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skill validation and server actions</name>
  <files>
    - src/lib/validations/skill.ts
    - src/lib/actions/skills.ts
  </files>
  <action>
Create `src/lib/validations/skill.ts`:
- Zod schema with fields: name (required, 1-50 chars), icon (required, Lucide icon name string), category (required, one of: "frontend", "backend", "tools", "other")
- Export `skillSchema`, `SkillFormData`
- Export `SKILL_CATEGORIES` constant array for dropdown options

Create `src/lib/actions/skills.ts`:
- "use server"
- Import prisma, auth, revalidatePath

Actions:
- `getSkills()`: Fetch all skills ordered by category then order field. Group by category in return.
- `getSkillCategories()`: Return unique categories with their display order (derive from first skill in category or maintain separate).
- `createSkill(formData: FormData)`: Validate, create with order = max order in category + 1. Return ActionResult with created skill.
- `updateSkill(id: string, formData: FormData)`: Validate and update skill.
- `deleteSkill(id: string)`: Delete skill by ID.
- `updateSkillsOrder(updates: { id: string; order: number }[])`: Bulk update order within a category. Use prisma.$transaction for atomic update.
- `updateCategoryOrder(categoryOrder: string[])`: Update order of skills to reflect category reordering (shift all skills in each category to new order ranges).

All actions check auth first, return error if not authenticated.
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
  </verify>
  <done>
Skill validation and server actions ready for CRUD and reordering operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create drag-and-drop skill components</name>
  <files>
    - src/components/admin/sortable-skill-item.tsx
    - src/components/admin/skill-category.tsx
  </files>
  <action>
Create `src/components/admin/sortable-skill-item.tsx`:
- "use client"
- Use useSortable from @dnd-kit/sortable
- Props: skill object, onEdit callback, onDelete callback
- Display: drag handle (GripVertical icon), skill icon (dynamic Lucide), skill name
- Edit button (Pencil icon) and Delete button (Trash2 icon)
- Apply CSS transform from useSortable
- Visual feedback when dragging (opacity, shadow)

Create `src/components/admin/skill-category.tsx`:
- "use client"
- Props: category name, skills array, onReorder callback
- Use SortableContext with verticalListSortingStrategy
- Render SortableSkillItem for each skill
- Category header with drag handle for category reordering
- Collapsible section (optional, Claude's discretion)
- Handle drag end: calculate new order, call onReorder with updates
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
  </verify>
  <done>
Drag-and-drop skill components ready with sortable items and category containers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build skills management page</name>
  <files>
    - src/app/backstage/dashboard/skills/page.tsx
  </files>
  <action>
Create `src/app/backstage/dashboard/skills/page.tsx`:

Server component wrapper:
- Fetch skills grouped by category with getSkills()
- Pass to client SkillsManager component

Client SkillsManager component:
- "use client"
- DndContext with closestCenter collision detection
- Sensors: PointerSensor and KeyboardSensor
- Two levels of drag-and-drop:
  1. Categories can be reordered (outer sortable context)
  2. Skills within category can be reordered (inner sortable contexts)
- Skills can only be dragged within their category (no cross-category drag)

Add Skill form/modal:
- Button "Add Skill" opens modal
- Form with: name input, icon selector (text input for Lucide icon name), category dropdown
- On submit: call createSkill, close modal, show toast

Edit Skill:
- Click edit on skill item opens same modal pre-filled
- On submit: call updateSkill, close modal, show toast

Delete Skill:
- Click delete shows confirmation dialog
- On confirm: call deleteSkill, show toast

Reorder handling:
- On drag end within category: calculate new orders, call updateSkillsOrder
- Use useOptimistic for instant UI update (wrap in startTransition)
- On server error: revert optimistic state, show error toast

Page layout:
- Header with title "Skills" and "Add Skill" button
- Categories displayed as sections
- Each section shows skills as sortable list
  </action>
  <verify>
- Visit `/backstage/dashboard/skills` - page loads
- Add skill: opens modal, creates skill, appears in correct category
- Edit skill: modal pre-fills, updates work
- Delete skill: confirmation appears, skill removed
- Drag skill within category: reorders with immediate visual feedback
- Drag category: reorders categories
- Refresh page: order persists
  </verify>
  <done>
Skills section complete: full CRUD, drag-and-drop within categories, category reordering, optimistic updates.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/backstage/dashboard/skills`
2. Add a skill (e.g., "React" with "code" icon in "frontend" category)
3. Add another skill in same category
4. Drag to reorder within category - instant visual feedback
5. Refresh - order persists
6. Edit a skill - changes save
7. Delete a skill - removed after confirmation
8. Add skills to different categories, reorder categories
</verification>

<success_criteria>
- Skills CRUD operations work with proper validation
- Drag-and-drop reorders skills within category only (no cross-category)
- Category order is draggable
- Reorder persists immediately to database
- Optimistic UI updates provide instant feedback
- Toast notifications for all operations
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer-admin-crud/03-03-SUMMARY.md`
</output>
