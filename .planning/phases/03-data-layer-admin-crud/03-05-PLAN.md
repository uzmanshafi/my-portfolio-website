---
phase: 03-data-layer-admin-crud
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/validations/resume.ts
  - src/lib/actions/resume.ts
  - src/app/backstage/dashboard/resume/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can upload a resume PDF file"
    - "Admin can replace existing resume with new upload"
    - "Current resume filename and upload date are displayed"
    - "PDF upload respects 10MB size limit with clear error message"
    - "Resume uploads to Supabase Storage"
  artifacts:
    - path: "src/lib/validations/resume.ts"
      provides: "Validation for resume file"
      exports: ["validateResumeFile"]
    - path: "src/lib/actions/resume.ts"
      provides: "Server actions for resume management"
      exports: ["getActiveResume", "uploadResume", "deleteResume"]
    - path: "src/app/backstage/dashboard/resume/page.tsx"
      provides: "Resume upload page"
  key_links:
    - from: "src/app/backstage/dashboard/resume/page.tsx"
      to: "src/lib/actions/storage.ts"
      via: "signed URL upload"
      pattern: "getSignedUploadUrl"
    - from: "src/app/backstage/dashboard/resume/page.tsx"
      to: "src/lib/actions/resume.ts"
      via: "database update"
      pattern: "uploadResume"
---

<objective>
Build the Resume section for uploading and managing the portfolio resume PDF file.

Purpose: Allow admin to upload a resume/CV PDF that visitors can download, and replace it when needed.

Output: Functional resume upload page with file validation, Supabase Storage integration, and current resume display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-data-layer-admin-crud/03-CONTEXT.md
@.planning/phases/03-data-layer-admin-crud/03-RESEARCH.md
@prisma/schema.prisma
@src/lib/actions/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resume validation and server actions</name>
  <files>
    - src/lib/validations/resume.ts
    - src/lib/actions/resume.ts
  </files>
  <action>
Create `src/lib/validations/resume.ts`:
- `validateResumeFile(file: File)`: Validate file is PDF and under 10MB
- Return `{ valid: true }` or `{ valid: false, error: string }`
- Error messages: "Only PDF files are allowed", "File size must be under 10MB"

Create `src/lib/actions/resume.ts`:
- "use server"
- Import prisma, auth, revalidatePath

Actions:
- `getActiveResume()`: Fetch the resume record where active = true. Return null if none exists.
- `uploadResume(filename: string, url: string)`:
  1. Set all existing resumes to active = false (only one active at a time)
  2. Create new resume record with filename, url, active = true
  3. Return ActionResult with new resume
- `deleteResume(id: string)`: Delete resume record and optionally clean up storage file.

Note: Actual file upload goes directly to Supabase via signed URL. These actions manage the database record.

All actions check auth first.
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
  </verify>
  <done>
Resume validation and server actions ready for upload tracking and management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build resume upload page</name>
  <files>
    - src/app/backstage/dashboard/resume/page.tsx
  </files>
  <action>
Create `src/app/backstage/dashboard/resume/page.tsx`:

Server component wrapper:
- Fetch active resume with getActiveResume()
- Pass to client ResumeManager component

Client ResumeManager component:
- "use client"

Current Resume Display (if exists):
- Card showing:
  - PDF icon (FileText from Lucide)
  - Filename
  - Upload date (formatted nicely)
  - "View" link (opens PDF in new tab)
  - "Replace" button

No Resume State:
- Message: "No resume uploaded yet"
- "Upload Resume" button

Upload Flow:
1. Click "Upload Resume" or "Replace" - opens file picker
2. Accept only .pdf files
3. On file select:
   - Validate with validateResumeFile (check type and size)
   - If invalid: show error toast, don't proceed
   - If valid: show loading state
4. Get signed URL: getSignedUploadUrl("portfolio-assets", `resume/${Date.now()}_${filename}`)
5. Upload file to Supabase using signed URL (direct fetch with PUT)
6. On upload success: call uploadResume(filename, publicUrl)
7. Show success toast
8. On any error: show error toast

Delete Resume (optional):
- "Delete" button on current resume
- Confirmation dialog
- On confirm: deleteResume, show toast

Page styling:
- Center content
- Card-based layout
- Clear call-to-action
- Drag-and-drop zone (optional enhancement, Claude's discretion)
  </action>
  <verify>
- Visit `/backstage/dashboard/resume` - page loads
- Upload a PDF: file uploads, record created, displays in UI
- Try uploading non-PDF: error toast appears
- Try uploading file > 10MB: error toast appears
- Click "View" on uploaded resume: opens PDF in new tab
- Replace resume: new file uploads, old record deactivated
- Refresh page: resume persists
  </verify>
  <done>
Resume section complete: PDF upload with validation, Supabase storage, current resume display with view/replace functionality.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/backstage/dashboard/resume`
2. Verify empty state message shows
3. Upload a valid PDF file (under 10MB)
4. Verify file appears with filename and date
5. Click View - opens PDF
6. Try uploading a non-PDF - error message
7. Try uploading file > 10MB - error message
8. Replace with new PDF - old one deactivated, new one active
9. Refresh - new resume persists
</verification>

<success_criteria>
- PDF files upload successfully to Supabase Storage
- Non-PDF files rejected with clear error
- Files over 10MB rejected with clear error
- Current resume displays filename and upload date
- View link opens PDF in new tab
- Replace functionality works (only one active resume)
- Toast notifications for all operations
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer-admin-crud/03-05-SUMMARY.md`
</output>
