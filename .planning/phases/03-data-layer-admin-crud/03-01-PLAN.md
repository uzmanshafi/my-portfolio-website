---
phase: 03-data-layer-admin-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/validations/common.ts
  - src/hooks/use-unsaved-changes.ts
  - src/app/backstage/dashboard/layout.tsx
  - src/components/admin/sidebar.tsx
  - src/components/admin/unsaved-changes-modal.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Cloud storage for profile images and resume PDFs"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (keep secret)"
    dashboard_config:
      - task: "Create 'portfolio-assets' storage bucket"
        location: "Supabase Dashboard -> Storage -> New bucket"
        details: "Name: portfolio-assets, Public bucket: No"

must_haves:
  truths:
    - "Dashboard has sidebar navigation to all content sections"
    - "Mobile users see hamburger menu that opens sidebar as overlay"
    - "Unsaved changes warning appears when navigating away with dirty form"
    - "Supabase client can generate signed upload URLs"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createSupabaseBrowserClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client with service role"
      exports: ["createSupabaseServerClient"]
    - path: "src/components/admin/sidebar.tsx"
      provides: "Dashboard sidebar navigation component"
      exports: ["Sidebar"]
    - path: "src/hooks/use-unsaved-changes.ts"
      provides: "Hook for detecting unsaved form changes"
      exports: ["useUnsavedChanges"]
  key_links:
    - from: "src/app/backstage/dashboard/layout.tsx"
      to: "src/components/admin/sidebar.tsx"
      via: "import and render"
      pattern: "import.*Sidebar.*from"
---

<objective>
Set up Phase 3 infrastructure: install required packages, configure Supabase clients for file uploads, create dashboard sidebar navigation, and build shared form utilities.

Purpose: Provide the foundation that all content section pages will use - navigation, file upload capability, and form state management.

Output: Dashboard with working sidebar navigation, Supabase ready for file uploads, and reusable form hooks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-layer-admin-crud/03-CONTEXT.md
@.planning/phases/03-data-layer-admin-crud/03-RESEARCH.md
@src/app/backstage/dashboard/layout.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and create Supabase clients</name>
  <files>
    - package.json
    - src/lib/supabase/client.ts
    - src/lib/supabase/server.ts
    - src/lib/validations/common.ts
  </files>
  <action>
Install required packages:
```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities react-easy-crop @supabase/supabase-js @supabase/ssr react-hook-form @hookform/resolvers
```

Create browser Supabase client at `src/lib/supabase/client.ts`:
- Use `createBrowserClient` from `@supabase/ssr`
- Read NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY from env
- Export `createSupabaseBrowserClient()` function

Create server Supabase client at `src/lib/supabase/server.ts`:
- Use `createClient` from `@supabase/supabase-js` directly (not ssr package)
- Use SUPABASE_SERVICE_ROLE_KEY for bypassing RLS (secure since server-only)
- Export `createSupabaseServerClient()` function
- Do NOT use cookies - this is for storage operations only, not auth

Create common validation schemas at `src/lib/validations/common.ts`:
- Export `ActionResult` type: `{ success: boolean; error?: string; data?: T }`
- Export file validation helpers: `maxFileSize(bytes)`, `allowedFileTypes(types[])`
  </action>
  <verify>
- `npm ls @dnd-kit/core @supabase/supabase-js react-hook-form` shows packages installed
- Files exist at specified paths
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Packages installed, Supabase clients created with service role for storage, common validation types defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard sidebar with navigation</name>
  <files>
    - src/components/admin/sidebar.tsx
    - src/app/backstage/dashboard/layout.tsx
  </files>
  <action>
Create sidebar component at `src/components/admin/sidebar.tsx`:
- "use client" component (needs usePathname for active state)
- Persistent left sidebar with links: Dashboard (home), Bio, Skills, Projects, Resume, Contact
- Use Lucide icons: LayoutDashboard, User, Zap, FolderKanban, FileText, Mail
- Highlight active link based on current pathname
- Desktop: visible sidebar, fixed width (~240px)
- Mobile: hamburger button in header that opens sidebar as full-screen overlay
- Use CSS variables from globals.css for colors
- Add small dot indicator next to section name (placeholder for unsaved changes - will wire in 03-07)
- Close mobile overlay when clicking a link

Update `src/app/backstage/dashboard/layout.tsx`:
- Import and render Sidebar component
- Change layout to flex row: sidebar on left, content on right
- Keep existing header but move logout button to sidebar bottom on desktop
- On mobile, header shows hamburger button and title only
- Main content area gets proper padding
  </action>
  <verify>
- Visit `/backstage/dashboard` - sidebar visible with all section links
- Click each link - navigates to correct URL (pages will 404 until built, that's OK)
- Active link is highlighted
- Resize to mobile width - hamburger menu appears
- Click hamburger - overlay sidebar opens
- Click link in overlay - navigates and overlay closes
  </verify>
  <done>
Dashboard has sidebar navigation to Bio, Skills, Projects, Resume, Contact sections. Mobile users see hamburger menu with overlay sidebar.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unsaved changes hook and modal</name>
  <files>
    - src/hooks/use-unsaved-changes.ts
    - src/components/admin/unsaved-changes-modal.tsx
  </files>
  <action>
Create `src/hooks/use-unsaved-changes.ts`:
- Accept `isDirty: boolean` parameter
- Handle browser close/refresh with beforeunload event
- Return `{ isDirty }` for component use
- Add comment explaining App Router navigation limitation (no built-in interception)

Create `src/components/admin/unsaved-changes-modal.tsx`:
- "use client" component
- Props: `isOpen`, `onClose`, `onConfirm`, `onCancel`
- Modal overlay with dark backdrop
- Message: "You have unsaved changes. Leave anyway?"
- Two buttons: "Stay" (onCancel) and "Leave" (onConfirm)
- Style with CSS variables
- Trap focus within modal when open
- Close on Escape key

Note: The modal will be wired up to sidebar navigation clicks in Plan 03-07 when all forms exist.
  </action>
  <verify>
- Files exist at specified paths
- TypeScript compiles: `npx tsc --noEmit`
- Hook can be imported: create temp test file that imports useUnsavedChanges
  </verify>
  <done>
Unsaved changes hook handles browser refresh warning. Modal component ready for integration with sidebar navigation.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @dnd-kit/core @supabase/supabase-js react-hook-form react-easy-crop` - all packages present
2. `npx tsc --noEmit` - no TypeScript errors
3. Visit `/backstage/dashboard` - sidebar visible
4. All sidebar links present: Dashboard, Bio, Skills, Projects, Resume, Contact
5. Mobile view shows hamburger menu that opens sidebar overlay
</verification>

<success_criteria>
- All 8 packages installed and importable
- Supabase clients export correctly
- Dashboard layout has responsive sidebar navigation
- Unsaved changes hook and modal ready for use
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer-admin-crud/03-01-SUMMARY.md`
</output>
