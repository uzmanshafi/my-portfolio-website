---
phase: 03-data-layer-admin-crud
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/validations/bio.ts
  - src/lib/actions/bio.ts
  - src/lib/actions/storage.ts
  - src/components/admin/image-cropper.tsx
  - src/app/backstage/dashboard/bio/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can edit bio name, title, headline, and description"
    - "Admin can upload and crop profile image to 1:1 aspect ratio"
    - "Bio changes save to database with success toast"
    - "Profile image uploads to Supabase Storage"
    - "Form shows validation errors on blur and submit"
  artifacts:
    - path: "src/lib/validations/bio.ts"
      provides: "Zod schema for bio validation"
      exports: ["bioSchema", "BioFormData"]
    - path: "src/lib/actions/bio.ts"
      provides: "Server actions for bio CRUD"
      exports: ["getBio", "updateBio", "updateProfileImage"]
    - path: "src/lib/actions/storage.ts"
      provides: "Signed URL generation for uploads"
      exports: ["getSignedUploadUrl", "deleteStorageFile"]
    - path: "src/components/admin/image-cropper.tsx"
      provides: "Profile image crop component"
      exports: ["ImageCropper"]
    - path: "src/app/backstage/dashboard/bio/page.tsx"
      provides: "Bio editing page"
  key_links:
    - from: "src/app/backstage/dashboard/bio/page.tsx"
      to: "src/lib/actions/bio.ts"
      via: "form submission"
      pattern: "updateBio"
    - from: "src/components/admin/image-cropper.tsx"
      to: "src/lib/actions/storage.ts"
      via: "signed URL upload"
      pattern: "getSignedUploadUrl"
---

<objective>
Build the Bio section of the admin dashboard with form editing, validation, and profile image upload with cropping.

Purpose: Allow admin to edit personal information (name, title, headline, description) and upload a cropped profile image.

Output: Functional bio editing page with form validation, image cropper, and Supabase Storage integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-data-layer-admin-crud/03-CONTEXT.md
@.planning/phases/03-data-layer-admin-crud/03-RESEARCH.md
@prisma/schema.prisma
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bio validation schema and server actions</name>
  <files>
    - src/lib/validations/bio.ts
    - src/lib/actions/bio.ts
    - src/lib/actions/storage.ts
  </files>
  <action>
Create `src/lib/validations/bio.ts`:
- Zod schema with fields: name (required, 1-100 chars), title (required, 1-100 chars), headline (required, 1-200 chars), description (required, min 10 chars)
- Export `bioSchema` and `BioFormData` type

Create `src/lib/actions/storage.ts`:
- "use server"
- Import auth from @/lib/auth to verify session
- Import createSupabaseServerClient from @/lib/supabase/server
- `getSignedUploadUrl(bucket: string, path: string)`: Generate signed upload URL for client-side upload. Returns `{ signedUrl, token }` or `{ error }`. Validate auth first.
- `deleteStorageFile(bucket: string, path: string)`: Delete file from storage. For cleanup when replacing images.
- Use service role client (bypasses RLS)

Create `src/lib/actions/bio.ts`:
- "use server"
- Import prisma, auth, revalidatePath, bioSchema
- `getBio()`: Fetch current bio (use findFirst, may not exist yet)
- `updateBio(formData: FormData)`: Validate with bioSchema, upsert to database. Use a fixed ID like "main" for singleton pattern. Return ActionResult.
- `updateProfileImage(imageUrl: string)`: Update only the imageUrl field. Called after successful upload.
- All actions check auth session first, return error if not authenticated
  </action>
  <verify>
- Files exist with correct exports
- `npx tsc --noEmit` passes
- Actions are marked "use server"
  </verify>
  <done>
Bio validation schema and server actions created with proper authentication checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image cropper component</name>
  <files>
    - src/components/admin/image-cropper.tsx
  </files>
  <action>
Create `src/components/admin/image-cropper.tsx`:
- "use client" component
- Use react-easy-crop for cropping UI
- Props: `imageSrc: string`, `onCropComplete: (blob: Blob) => void`, `onCancel: () => void`
- Fixed 1:1 aspect ratio (square crop)
- Zoom slider control (1x to 3x)
- Crop shape: "round" for profile images
- Buttons: Cancel and Save Crop
- Implement `getCroppedImg` helper function:
  - Create canvas element
  - Draw cropped region
  - Return as Blob (image/jpeg, quality 0.9)
- Style modal overlay with dark backdrop
- Set crossOrigin="anonymous" on image element to avoid tainted canvas
  </action>
  <verify>
- File exists at path
- `npx tsc --noEmit` passes
- Component exports ImageCropper
  </verify>
  <done>
Image cropper component ready with 1:1 aspect ratio, zoom control, and canvas-based crop output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build bio editing page with form and image upload</name>
  <files>
    - src/app/backstage/dashboard/bio/page.tsx
  </files>
  <action>
Create `src/app/backstage/dashboard/bio/page.tsx`:

Server component wrapper that:
- Fetches initial bio data with getBio()
- Passes to client BioForm component

Create client BioForm component (can be in same file or separate):
- "use client"
- Use react-hook-form with zodResolver(bioSchema)
- Mode: "onBlur" for validation timing
- Fields: name, title, headline, description (textarea)
- Show field errors below each input
- Save button disabled when form is clean or pending
- On submit: call updateBio server action, show toast on success/error
- Use useUnsavedChanges hook with form.formState.isDirty

Profile image upload section:
- Show current profile image (or placeholder)
- "Change Image" button opens file picker
- Accept only image/* files, max 5MB
- On file select: show ImageCropper modal
- On crop complete:
  1. Get signed URL from getSignedUploadUrl("portfolio-assets", `profile/${Date.now()}.jpg`)
  2. Upload cropped blob directly to Supabase using signed URL
  3. Call updateProfileImage with the public URL
  4. Show toast on success/error
- Show loading state during upload

Style with CSS variables, consistent with dashboard theme.
  </action>
  <verify>
- Visit `/backstage/dashboard/bio` - page loads without error
- Form displays all fields
- Validation errors show on blur for invalid input
- Save button works (creates/updates bio in database)
- Toast appears on save success
- Image upload opens cropper
- After cropping and upload, new image appears
  </verify>
  <done>
Bio section complete: admin can edit text fields with validation, upload and crop profile image, all changes persist to database with feedback.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/backstage/dashboard/bio`
2. Fill out bio form with valid data, click Save - toast shows success
3. Refresh page - data persists
4. Clear a required field, blur - validation error appears
5. Upload image, crop it, confirm - image updates and persists
6. Check Supabase Storage bucket - image file exists
</verification>

<success_criteria>
- Bio form validates on blur and submit
- Bio data saves to PostgreSQL via Prisma
- Profile image uploads to Supabase Storage via signed URL
- Image cropper enforces 1:1 aspect ratio
- Toast notifications provide feedback
- Form tracks dirty state for unsaved changes warning
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer-admin-crud/03-02-SUMMARY.md`
</output>
